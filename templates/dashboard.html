{% extends "base.html" %}

{% block content %}
    <!-- 引入各个功能模块 -->
    {% include "modules/search.html" %}
    {% include "modules/overview.html" %}

    <!-- 基金公司分析概览 -->
    <div class="row mt-4" id="company-analytics-section" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">基金公司分析概览
                        <small class="text-muted">
                            (当前按 
                            {% if current_sort_by == 'total_holding_value' %}持仓价值
                            {% elif current_sort_by == 'product_count' %}产品数量
                            {% elif current_sort_by == 'total_fund_size' %}总规模
                            {% elif current_sort_by == 'total_amount' %}总成交额
                            {% elif current_sort_by == 'total_attention_count' %}自选人数
                            {% elif current_sort_by == 'total_holder_count_holders' %}持仓人数
                            {% elif current_sort_by == 'holder_attention_ratio' %}持仓自选比
                            {% elif current_sort_by == 'business_agreement_count' %}商务品数量
                            {% elif current_sort_by == 'business_agreement_ratio' %}商务品占比
                            {% elif current_sort_by == 'latest_date' %}数据日期
                            {% else %}{{ current_sort_by }}
                            {% endif %}
                            {{ '升序' if current_order == 'asc' else '降序' }}排序)
                        </small>
                    </h4>
                </div>
                <div class="card-body">
                    {% if company_analytics %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm fixed-column-table">
                            <thead class="sticky-header">
                                <tr>
                                    <th style="width: 5%;">序号</th>
                                    <th style="width: 15%; cursor: pointer;" onclick="sortCompanyTable('company_short_name')">基金公司 <span class="sort-indicator" data-column="company_short_name"></span></th>
                                    <th style="width: 7%; cursor: pointer;" onclick="sortCompanyTable('product_count')">产品数量 <span class="sort-indicator" data-column="product_count"></span></th>
                                    <th style="width: 7%; cursor: pointer;" onclick="sortCompanyTable('business_agreement_count')">商务品数量 <span class="sort-indicator" data-column="business_agreement_count"></span></th>
                                    <th style="width: 7%; cursor: pointer;" onclick="sortCompanyTable('business_agreement_ratio')">商务品占比 (%) <span class="sort-indicator" data-column="business_agreement_ratio"></span></th>
                                    <th style="width: 10%; cursor: pointer;" onclick="sortCompanyTable('total_fund_size')">总管理规模 (亿元) <span class="sort-indicator" data-column="total_fund_size"></span></th>
                                    <th style="width: 10%; cursor: pointer;" onclick="sortCompanyTable('total_amount')">总成交额 (亿元) <span class="sort-indicator" data-column="total_amount"></span></th>
                                    <th style="width: 8%; cursor: pointer;" onclick="sortCompanyTable('total_attention_count')">总自选热度 <span class="sort-indicator" data-column="total_attention_count"></span></th>
                                    <th style="width: 8%; cursor: pointer;" onclick="sortCompanyTable('total_holder_count_holders')">总持仓人数 <span class="sort-indicator" data-column="total_holder_count_holders"></span></th>
                                    <th style="width: 8%; cursor: pointer;" onclick="sortCompanyTable('holder_attention_ratio')">持仓自选比 (%) <span class="sort-indicator" data-column="holder_attention_ratio"></span></th>
                                    <th style="width: 10%; cursor: pointer;" onclick="sortCompanyTable('total_holding_value')">总持仓价值 (亿元) <span class="sort-indicator" data-column="total_holding_value"></span></th>
                                </tr>
                            </thead>
                            {# Add id to tbody for AJAX update #}
                            <tbody id="company-analytics-tbody">
                                {# Initial table body content will be rendered by the main template include #}
                                {% include '_company_analytics_table_body.html' %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center">暂无基金公司分析数据。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% include "modules/business.html" %}
    {% include "modules/report.html" %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to check URL parameters and decide module visibility
        // This function is now largely superseded by the logic in dashboard.js DOMContentLoaded
        // We can keep it minimal or remove it if dashboard.js handles initial state fully.
        /*
        function manageModuleVisibility() {
            const companyAnalyticsSection = document.getElementById('company-analytics-section');
            const urlParams = new URLSearchParams(window.location.search);
            const activeModuleParam = urlParams.get('active_module');

            if (companyAnalyticsSection) {
                let showCompanyTable = true; 
                if (activeModuleParam && activeModuleParam !== 'market_overview') {
                    showCompanyTable = false;
                }
                // Defaulting to hidden, let dashboard.js logic explicitly show it.
                // companyAnalyticsSection.style.display = showCompanyTable ? '' : 'none'; 
            }
        }
        // manageModuleVisibility(); // Called by dashboard.js logic now
        // window.addEventListener('popstate', manageModuleVisibility); // popstate should also be handled by main init logic
        */
       console.log('[dashboard.html] Inline script: Initial module visibility will be handled by dashboard.js');
    });
</script>
{% endblock %}

{% endblock %}
